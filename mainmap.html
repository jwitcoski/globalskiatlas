<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KJGNL3KJL0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-KJGNL3KJL0');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4372859798489282" crossorigin="anonymous"></script>
  <title>Online Atlas â€“ Global Ski Atlas</title>
  <link rel="shortcut icon" href="./assets/logo.png?v=2" type="image/x-icon" />
  <link rel="stylesheet" href="./css/tailwind-build.css" />
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: system-ui, -apple-system, sans-serif; }
    #map { position: absolute; inset: 0; width: 100%; height: 100%; }
    .map-wrapper { flex: 1; min-height: 0; position: relative; margin-top: 60px; }
    .map-legend {
      position: absolute;
      bottom: 24px;
      left: 24px;
      z-index: 1000;
      background: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .map-legend h3 { margin: 0 0 8px 0; font-size: 13px; }
    .map-legend .legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .map-legend .legend-swatch { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
    .map-legend .legend-line { width: 18px; height: 4px; border-radius: 2px; flex-shrink: 0; display: inline-block; }
    .popup-table { border-collapse: collapse; font-size: 13px; }
    .popup-table th { text-align: left; padding: 2px 8px 2px 0; color: #666; font-weight: 500; }
    .popup-table td { padding: 2px 0; }
    .search-box {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      width: 90%;
      max-width: 360px;
    }
    .search-box input {
      width: 100%;
      padding: 10px 14px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      outline: none;
    }
    .search-box input:focus { border-color: #2563eb; }
    .search-box .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-height: 280px;
      overflow-y: auto;
      display: none;
    }
    .search-box .search-dropdown.visible { display: block; }
    .search-box .search-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .search-box .search-item:hover,
    .search-box .search-item.active { background: #f0f4ff; }
    .search-box .search-item:last-child { border-bottom: none; }
    .lift-marker-icon { background: none !important; border: none !important; }
  </style>
</head>
<body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-[#fff]">
  <header
    class="tw-absolute tw-top-0 tw-z-[1001] tw-flex tw-h-[60px] tw-w-full tw-bg-white tw-shadow-sm
           tw-border-b tw-border-gray-200 tw-px-[5%] max-lg:tw-mr-auto max-lg:tw-px-4 lg:tw-justify-around"
  >
    <a class="tw-h-[50px] tw-w-[50px] tw-p-[4px]" href="index.html" aria-label="Global Ski Atlas home">
      <img src="./assets/logo.png?v=2" alt="Global Ski Atlas" class="tw-object tw-h-full tw-w-full" />
    </a>
    <div class="collapsible-header animated-collapse max-lg:tw-shadow-md" id="collapsed-header-items">
      <div
        class="tw-flex tw-h-full tw-w-max tw-gap-5 tw-text-base tw-text-black
               max-lg:tw-mt-[30px] max-lg:tw-flex-col max-lg:tw-place-items-end
               max-lg:tw-gap-5 lg:tw-mx-auto lg:tw-place-items-center"
      >
        <a class="header-links" href="index.html#paths">Coffee Table Book</a>
        <a class="header-links tw-font-semibold" href="mainmap.html">Online Atlas</a>
        <a class="header-links" href="index.html#about">About</a>
        <a class="header-links" href="index.html#ai-assistant-detail">AI Assistant</a>
        <a class="header-links" href="resort-comparison.html">Compare Resorts</a>
      </div>
      <div
        class="tw-mx-4 tw-flex tw-place-items-center tw-gap-[20px] tw-text-base
               max-md:tw-w-full max-md:tw-flex-col max-md:tw-place-content-center"
      >
        <a
          href=""
          aria-label="signup"
          class="tw-flex tw-h-[40px] tw-place-items-center tw-gap-2 tw-rounded-full
                 tw-bg-black tw-p-1 tw-pl-4 tw-text-white"
        >
          <span>Download App Coming Soon</span>
          <div
            class="tw-flex tw-h-[30px] tw-w-[30px] tw-place-content-center
                   tw-place-items-center tw-rounded-full tw-bg-primary
                   tw-font-semibold tw-text-black"
          >
            <i class="bi bi-download"></i>
          </div>
        </a>
      </div>
    </div>
    <button
      class="bi bi-list tw-absolute tw-right-3 tw-top-3 tw-z-50 tw-text-3xl
             tw-text-black lg:tw-hidden"
      onclick="toggleHeader()"
      aria-label="menu"
      id="collapse-btn"
    ></button>
  </header>

  <div class="map-wrapper tw-flex-1 tw-min-h-0">
    <div id="map"></div>
    <div class="search-box" id="searchBox" style="display: none;">
      <input type="text" id="searchInput" placeholder="Search for a resort..." autocomplete="off" />
      <div class="search-dropdown" id="searchDropdown"></div>
    </div>
    <div id="legend" class="map-legend" style="display: none;"></div>
  </div>

  <footer
    class="tw-flex tw-w-full tw-place-content-around tw-gap-3 tw-border-t tw-border-gray-200
           tw-bg-gray-50 tw-py-6 tw-px-[10%] tw-text-black max-md:tw-flex-col"
  >
    <div
      class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-place-items-center tw-gap-6
             max-md:tw-w-full"
    >
      <img src="./assets/logo.png?v=2" alt="Global Ski Atlas" class="tw-max-w-[120px]" />
      <div>Global Ski Atlas</div>
      <div class="tw-mt-3 tw-text-lg tw-font-semibold">Follow us</div>
      <div class="tw-flex tw-gap-4 tw-text-2xl">
        <a href="" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
        <a href="https://twitter.com/@pauls_freeman" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
        <a href="https://instagram.com/" class="tw-h-[40px] tw-w-[40px]" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
      </div>
    </div>
    <div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-gap-4">
      <h2 class="tw-text-3xl max-md:tw-text-xl">Explore</h2>
      <div class="tw-flex tw-flex-col tw-gap-3 max-md:tw-text-sm">
        <a href="index.html#paths" class="footer-link">Coffee Table Book</a>
        <a href="mainmap.html" class="footer-link">Online Atlas</a>
        <a href="resort-comparison.html" class="footer-link">Compare Resorts</a>
        <a href="index.html#ai-assistant-detail" class="footer-link">AI Assistant</a>
      </div>
    </div>
    <div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-gap-4">
      <h2 class="tw-text-3xl max-md:tw-text-xl">Download Parquet Data</h2>
      <div class="tw-flex tw-flex-col tw-gap-3 max-md:tw-text-sm">
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas_analyzed.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>ski_areas_analyzed.parquet <i class="bi bi-download tw-text-sm"></i></a>
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>ski_areas.parquet <i class="bi bi-download tw-text-sm"></i></a>
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/lifts.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>lifts.parquet <i class="bi bi-download tw-text-sm"></i></a>
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/pistes.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>pistes.parquet <i class="bi bi-download tw-text-sm"></i></a>
      </div>
    </div>
    <div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-gap-4">
      <h2 class="tw-text-3xl max-md:tw-text-xl">Resources</h2>
      <div class="tw-flex tw-flex-col tw-gap-3 max-md:tw-text-sm">
        <a href="index.html#about" class="footer-link">About</a>
        <a href="" class="footer-link">FAQ</a>
        <a href="https://witcoskitech.com" class="footer-link" target="_blank" rel="noopener">Contact</a>
        <a href="privacy-policy.html" class="footer-link">Privacy Policy</a>
      </div>
    </div>
  </footer>

  <script>
    function toggleHeader() {
      var el = document.getElementById('collapsed-header-items');
      if (el) el.classList.toggle('animated-collapse');
    }
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-textpath@1.2.0/leaflet.textpath.js" crossorigin=""></script>
  <script type="module">
    const MAPTILER_KEY = '0P06ORgY8WvmMOnPr0p2';
    const GEOPARQUET_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas_analyzed.parquet';
    const SKI_AREAS_OUTLINES_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas.parquet';
    const LIFTS_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/lifts.parquet';
    const PISTES_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/pistes.parquet';
    const OUTLINES_MIN_ZOOM = 10;
    const LIFTS_MIN_ZOOM = 10;
    const PISTES_MIN_ZOOM = 10;
    // Property keys (tried in order if first missing)
    const RESORT_TYPE_KEYS = ['resort_type', 'Resort Type'];
    const NOT_DOWNHILL = 'not a downhill ski resort';
    const SIZE_BY_KEYS = ['total_area_acres', 'Total Area Acres', 'area_acres'];
    const COLOR_BY_KEYS = ['downhill_trails', 'number_of_downhill_trails', 'Downhill Trails', 'trails'];
    const NAME_KEYS = ['name', 'resort_name', 'title', 'area_name', 'Name'];

    const map = L.map('map', {
      center: [0, 0],
      zoom: 3,
      minZoom: 3,
      maxZoom: 18
    });

    L.tileLayer(
      `https://api.maptiler.com/maps/winter-v4/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      {
        attribution: 'Â© <a href="https://www.maptiler.com/copyright/">MapTiler</a> Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        tileSize: 256,
        minZoom: 3,
        maxZoom: 18,
        crossOrigin: true
      }
    ).addTo(map);

    try {
      const { asyncBufferFromUrl, parquetReadObjects } = await import('https://esm.sh/hyparquet@1');
      const file = await asyncBufferFromUrl({ url: GEOPARQUET_URL });
      const data = await parquetReadObjects({ file });
      const latCol = data.length && (data[0].latitude != null ? 'latitude' : data[0].lat != null ? 'lat' : data[0].centroid_lat != null ? 'centroid_lat' : null);
      const lonCol = data.length && (data[0].longitude != null ? 'longitude' : data[0].lon != null ? 'lon' : data[0].centroid_lon != null ? 'centroid_lon' : null);
      const geojson = {
        type: 'FeatureCollection',
        features: data
          .filter((row) => row.geometry || (latCol && lonCol && row[latCol] != null && row[lonCol] != null))
          .map((row) => {
            if (row.geometry) {
              const { geometry, ...properties } = row;
              return { type: 'Feature', geometry, properties };
            }
            const lat = Number(row[latCol]), lon = Number(row[lonCol]);
            const { [latCol]: _lat, [lonCol]: _lon, ...properties } = row;
            return {
              type: 'Feature',
              geometry: { type: 'Point', coordinates: [lon, lat] },
              properties
            };
          })
      };

      function getProp(props, keyList) {
        if (!props) return undefined;
        for (const k of keyList) {
          if (Object.prototype.hasOwnProperty.call(props, k)) return props[k];
        }
        return undefined;
      }
      function isNotDownhill(props) {
        const v = getProp(props, RESORT_TYPE_KEYS);
        return v != null && String(v).toLowerCase().trim() === NOT_DOWNHILL.toLowerCase();
      }

      const TRAILS_RED = 10;   // < 10 trails = red
      const TRAILS_YELLOW = 30; // 10â€“30 = yellow, 30+ = green
      const sizeExtent = [Infinity, -Infinity];
      geojson.features.forEach((f) => {
        if (isNotDownhill(f.properties)) return;
        const sv = getProp(f.properties, SIZE_BY_KEYS);
        if (typeof sv === 'number' && !Number.isNaN(sv) && sv > 0) {
          sizeExtent[0] = Math.min(sizeExtent[0], sv);
          sizeExtent[1] = Math.max(sizeExtent[1], sv);
        }
      });
      if (sizeExtent[0] === Infinity) sizeExtent[0] = 0;
      if (sizeExtent[1] === -Infinity) sizeExtent[1] = 1;

      const radiusRange = [4, 18];
      function getColorFor(feature) {
        if (isNotDownhill(feature.properties)) return '#999999';
        const v = getProp(feature.properties, COLOR_BY_KEYS);
        if (v == null || v === '' || (typeof v === 'number' && Number.isNaN(v))) return '#c44d34';
        const n = typeof v === 'number' ? v : Number(v);
        if (Number.isNaN(n)) return '#c44d34';
        if (n < TRAILS_RED) return '#c44d34';   // red: < 10 trails
        if (n < TRAILS_YELLOW) return '#e6c229'; // yellow: 10â€“30
        return '#2d8a3e';                        // green: 30+
      }
      function getRadiusFor(feature) {
        if (isNotDownhill(feature.properties)) return 2;
        const v = getProp(feature.properties, SIZE_BY_KEYS);
        const n = typeof v === 'number' ? v : Number(v);
        if (n == null || Number.isNaN(n) || n <= 0) return radiusRange[0];
        const range = sizeExtent[1] - sizeExtent[0] || 1;
        const t = (n - sizeExtent[0]) / range;
        const r = radiusRange[0] + t * (radiusRange[1] - radiusRange[0]);
        return Math.round(Math.max(radiusRange[0], Math.min(radiusRange[1], r)));
      }
      function getMarkerStyle(feature) {
        const notDownhill = isNotDownhill(feature.properties);
        return {
          radius: getRadiusFor(feature),
          fillColor: getColorFor(feature),
          color: notDownhill ? '#bbb' : '#1a1a1a',
          weight: notDownhill ? 0.5 : 1,
          fillOpacity: notDownhill ? 0.2 : 0.85
        };
      }

      const legendEl = document.getElementById('legend');
      legendEl.style.display = 'block';
      legendEl.innerHTML =
        '<h3>Color: # downhill trails</h3>' +
        '<div class="legend-row"><span class="legend-swatch" style="background:#c44d34"></span> &lt; 10 trails</div>' +
        '<div class="legend-row"><span class="legend-swatch" style="background:#e6c229"></span> 10â€“30 trails</div>' +
        '<div class="legend-row"><span class="legend-swatch" style="background:#2d8a3e"></span> 30+ trails</div>' +
        '<h3 style="margin-top:10px">Size: total area (acres)</h3>' +
        '<div class="legend-row">Small dot: ' + (sizeExtent[0] === sizeExtent[1] ? sizeExtent[0] : sizeExtent[0].toLocaleString() + ' ac') + '</div>' +
        '<div class="legend-row">Large dot: ' + (sizeExtent[1].toLocaleString() + ' ac') + '</div>' +
        '<div class="legend-row" style="margin-top:6px"><span class="legend-swatch" style="background:#999;opacity:0.3"></span> Grey = not a downhill ski resort</div>' +
        '<h3 style="margin-top:10px">Pistes (zoom 10+) â€“ US colors</h3>' +
        '<div class="legend-row"><span class="legend-line" style="background:#22c55e"></span> Green = easy</div>' +
        '<div class="legend-row"><span class="legend-line" style="background:#2563eb"></span> Blue = intermediate</div>' +
        '<div class="legend-row"><span class="legend-line" style="background:#1a1a1a"></span> Black = advanced</div>' +
        '<div class="legend-row"><span class="legend-line" style="background:#991b1b"></span> Red = expert</div>';

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatPopupValue(v) {
        if (v == null) return 'â€”';
        if (typeof v === 'number') return Number.isInteger(v) ? v.toLocaleString() : Number(v).toLocaleString(undefined, { maximumFractionDigits: 2 });
        if (typeof v === 'boolean') return v ? 'Yes' : 'No';
        if (v && typeof v === 'object' && typeof v.toISOString === 'function') return v.toISOString().slice(0, 10);
        return String(v);
      }
      function labelForKey(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
      }
      function buildPopupHtml(properties) {
        if (!properties || !Object.keys(properties).length) return '<em>No data</em>';
        const rows = Object.entries(properties)
          .filter(([k]) => k !== 'geometry')
          .sort(([a], [b]) => a.localeCompare(b))
          .map(([k, v]) => '<tr><th>' + escapeHtml(labelForKey(k)) + '</th><td>' + escapeHtml(formatPopupValue(v)) + '</td></tr>');
        return '<table class="popup-table">' + rows.join('') + '</table>';
      }

      const searchResorts = [];
      const resortsLayer = L.geoJSON(geojson, {
        pointToLayer: function (feature, latlng) {
          const style = getMarkerStyle(feature);
          return L.circleMarker(latlng, style);
        },
        onEachFeature: function (feature, layer) {
          layer.bindPopup(buildPopupHtml(feature.properties), { maxWidth: 320 });
          const name = getProp(feature.properties, NAME_KEYS);
          if (name != null && String(name).trim() !== '') {
            searchResorts.push({
              name: String(name).trim(),
              layer,
              latlng: layer.getLatLng()
            });
          }
        }
      });
      resortsLayer.addTo(map);

      const searchBox = document.getElementById('searchBox');
      const searchInput = document.getElementById('searchInput');
      const searchDropdown = document.getElementById('searchDropdown');
      if (searchResorts.length) searchBox.style.display = 'block';

      const maxSuggestions = 8;
      let selectedIndex = -1;
      let currentMatches = [];

      function renderDropdown(matches) {
        currentMatches = matches.slice(0, maxSuggestions);
        selectedIndex = -1;
        if (currentMatches.length === 0) {
          searchDropdown.classList.remove('visible');
          searchDropdown.innerHTML = '';
          return;
        }
        searchDropdown.innerHTML = currentMatches.map((r, i) =>
          '<div class="search-item" data-index="' + i + '">' + escapeHtml(r.name) + '</div>'
        ).join('');
        searchDropdown.classList.add('visible');
        searchDropdown.querySelectorAll('.search-item').forEach((el, i) => {
          el.addEventListener('click', () => selectMatch(currentMatches[i]));
        });
      }
      function selectMatch(r) {
        searchDropdown.classList.remove('visible');
        searchInput.value = r.name;
        searchInput.blur();
        map.flyTo(r.latlng, 10, { duration: 0.6 });
        setTimeout(() => r.layer.openPopup(), 400);
      }
      function getMatches(query) {
        const q = query.toLowerCase().trim();
        if (q.length === 0) return [];
        return searchResorts.filter((r) => r.name.toLowerCase().includes(q));
      }

      searchInput.addEventListener('input', () => {
        renderDropdown(getMatches(searchInput.value));
      });
      searchInput.addEventListener('focus', () => {
        const q = searchInput.value.trim();
        renderDropdown(q.length ? getMatches(q) : []);
      });
      searchInput.addEventListener('keydown', (e) => {
        if (!searchDropdown.classList.contains('visible') || currentMatches.length === 0) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, currentMatches.length - 1);
          searchDropdown.querySelectorAll('.search-item').forEach((el, i) => el.classList.toggle('active', i === selectedIndex));
          return;
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          searchDropdown.querySelectorAll('.search-item').forEach((el, i) => el.classList.toggle('active', i === selectedIndex));
          return;
        }
        if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && currentMatches[selectedIndex]) selectMatch(currentMatches[selectedIndex]);
          else if (currentMatches[0]) selectMatch(currentMatches[0]);
          return;
        }
      });
      document.addEventListener('click', (e) => {
        if (!searchBox.contains(e.target)) searchDropdown.classList.remove('visible');
      });

      // Ski area polygon outlines (visible at zoom 10+)
      let outlinesLayer = null;
      try {
        const fileOutlines = await asyncBufferFromUrl({ url: SKI_AREAS_OUTLINES_URL });
        const dataOutlines = await parquetReadObjects({ file: fileOutlines });
        const outlinesGeojson = {
          type: 'FeatureCollection',
          features: dataOutlines
            .filter((row) => {
              const g = row.geometry;
              if (!g || !g.type) return false;
              const t = g.type;
              return t === 'Polygon' || t === 'MultiPolygon';
            })
            .map((row) => {
              const { geometry, ...properties } = row;
              return { type: 'Feature', geometry, properties };
            })
        };
        outlinesLayer = L.layerGroup();
        const outlineStyle = { color: '#000', weight: 2, fill: false, dashArray: '3, 6' };
        outlinesGeojson.features.forEach((feature) => {
          const polygonLayer = L.geoJSON(feature, { style: outlineStyle });
          polygonLayer.eachLayer((l) => outlinesLayer.addLayer(l));
          const name = getProp(feature.properties, NAME_KEYS);
          if (name == null || String(name).trim() === '') return;
          const geom = feature.geometry;
          let ring;
          if (geom.type === 'Polygon' && geom.coordinates && geom.coordinates[0]) {
            ring = geom.coordinates[0];
          } else if (geom.type === 'MultiPolygon' && geom.coordinates && geom.coordinates[0] && geom.coordinates[0][0]) {
            ring = geom.coordinates[0][0];
          } else return;
          const latlngs = ring.map((c) => L.latLng(c[1], c[0]));
          const pathLine = L.polyline(latlngs, { color: 'transparent', weight: 0, opacity: 0 });
          if (typeof pathLine.setText === 'function') {
            pathLine.setText(String(name).trim(), {
              repeat: false,
              center: true,
              attributes: { fill: '#1a1a1a', 'font-weight': 'bold', 'font-size': '13px' }
            });
          }
          outlinesLayer.addLayer(pathLine);
        });
        let liftsLayer = null;
        try {
          const fileLifts = await asyncBufferFromUrl({ url: LIFTS_URL });
          const dataLifts = await parquetReadObjects({ file: fileLifts });
          const liftsGeojson = {
            type: 'FeatureCollection',
            features: dataLifts
              .filter((row) => {
                const g = row.geometry;
                if (!g || !g.type) return false;
                const t = g.type;
                return t === 'LineString' || t === 'MultiLineString';
              })
              .map((row) => {
                const { geometry, ...properties } = row;
                return { type: 'Feature', geometry, properties };
              })
          };
          function getLineMidpoint(latlngs) {
            const flat = Array.isArray(latlngs[0]) && (typeof latlngs[0][0] === 'number' || (latlngs[0][0] && latlngs[0][0].lat == null))
              ? latlngs[0]
              : latlngs;
            if (!flat || !flat.length) return null;
            const i = Math.floor(flat.length / 2);
            return L.latLng(flat[i]);
          }
          const liftIcon = L.divIcon({
            className: 'lift-marker-icon',
            html: '<span style="font-size:14px;line-height:1;color:#dc2626;filter:drop-shadow(0 0 1px #fff);" title="Lift">ðŸš¡</span>',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
          });
          liftsLayer = L.layerGroup();
          const liftsLinesLayer = L.geoJSON(liftsGeojson, {
            style: { color: '#f87171', weight: 2, opacity: 0.9 }
          });
          liftsLinesLayer.eachLayer(function (lineLayer) {
            liftsLayer.addLayer(lineLayer);
            const latlngs = lineLayer.getLatLngs();
            const mid = latlngs.length ? getLineMidpoint(latlngs) : null;
            if (mid) liftsLayer.addLayer(L.marker(mid, { icon: liftIcon }));
          });
        } catch (liftErr) {
          console.warn('Lifts GeoParquet failed to load:', liftErr);
        }

        // Pistes (trails) â€“ US symbols and colors by difficulty
        let pistesLayer = null;
        const PISTE_DIFFICULTY_KEYS = ['piste:difficulty', 'piste_difficulty', 'difficulty'];
        function getPisteDifficulty(props) {
          let v = getProp(props, PISTE_DIFFICULTY_KEYS);
          if (v == null && props && typeof props.other_tags === 'string') {
            const m = props.other_tags.match(/"piste:difficulty"=>"([^"]+)"/);
            if (m) v = m[1];
          }
          return v != null ? String(v).toLowerCase().trim() : '';
        }
        function getPisteStyle(feature) {
          const d = getPisteDifficulty(feature.properties);
          // US: green circle = easy, blue square = intermediate, black diamond = advanced, double black = expert
          if (d === 'easy' || d === 'novice') return { color: '#22c55e', weight: 3, opacity: 0.95 };
          if (d === 'intermediate' || d === 'medium') return { color: '#2563eb', weight: 3, opacity: 0.95 };
          if (d === 'advanced' || d === 'hard') return { color: '#1a1a1a', weight: 3.5, opacity: 0.95 };
          if (d === 'expert' || d === 'freeride' || d === 'extreme') return { color: '#991b1b', weight: 4, opacity: 0.95 };
          return { color: '#64748b', weight: 2, opacity: 0.8 };
        }
        try {
          const filePistes = await asyncBufferFromUrl({ url: PISTES_URL });
          const dataPistes = await parquetReadObjects({ file: filePistes });
          const pistesGeojson = {
            type: 'FeatureCollection',
            features: dataPistes
              .filter((row) => {
                const g = row.geometry;
                if (!g || !g.type) return false;
                const t = g.type;
                return t === 'LineString' || t === 'MultiLineString';
              })
              .map((row) => {
                const { geometry, ...properties } = row;
                return { type: 'Feature', geometry, properties };
              })
          };
          pistesLayer = L.geoJSON(pistesGeojson, {
            style: getPisteStyle
          });
        } catch (pisteErr) {
          console.warn('Pistes GeoParquet failed to load:', pisteErr);
        }

        function updateZoomLayersVisibility() {
          const zoom = map.getZoom();
          if (outlinesLayer) {
            if (zoom >= OUTLINES_MIN_ZOOM) {
              if (!map.hasLayer(outlinesLayer)) map.addLayer(outlinesLayer);
            } else {
              if (map.hasLayer(outlinesLayer)) map.removeLayer(outlinesLayer);
            }
          }
          if (liftsLayer) {
            if (zoom >= LIFTS_MIN_ZOOM) {
              if (!map.hasLayer(liftsLayer)) map.addLayer(liftsLayer);
            } else {
              if (map.hasLayer(liftsLayer)) map.removeLayer(liftsLayer);
            }
          }
          if (pistesLayer) {
            if (zoom >= PISTES_MIN_ZOOM) {
              if (!map.hasLayer(pistesLayer)) map.addLayer(pistesLayer);
            } else {
              if (map.hasLayer(pistesLayer)) map.removeLayer(pistesLayer);
            }
          }
        }
        map.on('zoomend', updateZoomLayersVisibility);
        updateZoomLayersVisibility();
      } catch (outlineErr) {
        console.warn('Ski area outlines failed to load:', outlineErr);
      }
    } catch (err) {
      console.warn('Ski areas GeoParquet failed to load:', err);
      if (err.message && err.message.includes('fetch')) {
        console.warn('Tip: Add CORS and allow public GetObject on the S3 bucket. See docs/S3_EXPOSE_GEOPARQUET.md');
      }
    }
  </script>
</body>
</html>
