<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KJGNL3KJL0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-KJGNL3KJL0');
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4372859798489282" crossorigin="anonymous"></script>
  <title>Online Atlas â€“ Global Ski Atlas</title>
  <link rel="shortcut icon" href="./assets/logo.png?v=2" type="image/x-icon" />
  <link rel="stylesheet" href="./css/tailwind-build.css" />
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: system-ui, -apple-system, sans-serif; }
    #map { position: absolute; inset: 0; width: 100%; height: 100%; }
    .map-wrapper {
      flex: 1;
      min-height: 0;
      position: relative;
      margin-top: 60px;
      min-height: calc(100vh - 60px);
      min-height: calc(100dvh - 60px);
    }
    .map-legend {
      position: absolute;
      bottom: 24px;
      left: 24px;
      z-index: 1000;
      background: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .map-legend h3 { margin: 0 0 8px 0; font-size: 13px; }
    .map-legend .legend-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .map-legend .legend-swatch { width: 14px; height: 14px; border-radius: 50%; flex-shrink: 0; }
    .map-legend .legend-line { width: 18px; height: 4px; border-radius: 2px; flex-shrink: 0; display: inline-block; }
    .popup-table { border-collapse: collapse; font-size: 13px; }
    .popup-table th { text-align: left; padding: 2px 8px 2px 0; color: #666; font-weight: 500; }
    .popup-table td { padding: 2px 0; }
    .search-box {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      width: 90%;
      max-width: 360px;
    }
    .search-box input {
      width: 100%;
      padding: 10px 14px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      outline: none;
    }
    .search-box input:focus { border-color: #2563eb; }
    .search-box .search-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      max-height: 280px;
      overflow-y: auto;
      display: none;
    }
    .search-box .search-dropdown.visible { display: block; }
    .search-box .search-item {
      padding: 10px 14px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .search-box .search-item:hover,
    .search-box .search-item.active { background: #f0f4ff; }
    .search-box .search-item:last-child { border-bottom: none; }
    .lift-marker-icon { background: none !important; border: none !important; }
    .olympic-rings-marker { background: none !important; border: none !important; }
    .mountain-marker { background: none !important; border: none !important; }
    .legend-mountain-icon { display: inline-flex; align-items: center; vertical-align: middle; margin-right: 6px; }
    @media (max-width: 768px) {
      .map-wrapper {
        margin-top: 60px;
        min-height: calc(100vh - 60px);
        min-height: calc(100dvh - 60px);
      }
      .map-legend {
        bottom: 12px;
        left: 12px;
        padding: 8px 10px;
        font-size: 11px;
        max-height: 140px;
      }
      .map-legend h3 { font-size: 11px; margin: 0 0 4px 0; }
      .map-legend .legend-row { margin: 2px 0; gap: 6px; }
      .map-legend .legend-swatch { width: 10px; height: 10px; }
      .map-legend .legend-line { width: 14px; height: 3px; }
      .search-box { top: 8px; width: calc(100% - 24px); max-width: none; }
      .search-box input { padding: 8px 12px; font-size: 14px; }
    }
  </style>
</head>
<body class="tw-flex tw-min-h-[100vh] tw-flex-col tw-bg-[#fff]">
  <header
    class="tw-absolute tw-top-0 tw-z-[1001] tw-flex tw-h-[60px] tw-w-full tw-bg-white tw-shadow-sm
           tw-border-b tw-border-gray-200 tw-px-[5%] max-lg:tw-mr-auto max-lg:tw-px-4 lg:tw-justify-around"
  >
    <a class="tw-h-[50px] tw-w-[50px] tw-p-[4px]" href="index.html" aria-label="Global Ski Atlas home">
      <img src="./assets/logo.png?v=2" alt="Global Ski Atlas" class="tw-object tw-h-full tw-w-full" />
    </a>
    <div class="collapsible-header animated-collapse max-lg:tw-shadow-md" id="collapsed-header-items">
      <div
        class="tw-flex tw-h-full tw-w-max tw-gap-5 tw-text-base tw-text-black
               max-lg:tw-mt-[30px] max-lg:tw-flex-col max-lg:tw-place-items-end
               max-lg:tw-gap-5 lg:tw-mx-auto lg:tw-place-items-center"
      >
        <a class="header-links" href="coffee-table-book.html">Coffee Table Book</a>
        <a class="header-links tw-font-semibold" href="mainmap.html">Online Atlas</a>
        <a class="header-links" href="index.html#about">About</a>
        <a class="header-links" href="index.html#ai-assistant-detail">AI Assistant</a>
        <a class="header-links" href="resort-comparison.html">Compare Resorts</a>
      </div>
      <div
        class="tw-mx-4 tw-flex tw-place-items-center tw-gap-[20px] tw-text-base
               max-md:tw-w-full max-md:tw-flex-col max-md:tw-place-content-center"
      >
        <a
          href=""
          aria-label="signup"
          class="tw-flex tw-h-[40px] tw-place-items-center tw-gap-2 tw-rounded-full
                 tw-bg-black tw-p-1 tw-pl-4 tw-text-white"
        >
          <span>Download App Coming Soon</span>
          <div
            class="tw-flex tw-h-[30px] tw-w-[30px] tw-place-content-center
                   tw-place-items-center tw-rounded-full tw-bg-primary
                   tw-font-semibold tw-text-black"
          >
            <i class="bi bi-download"></i>
          </div>
        </a>
      </div>
    </div>
    <button
      class="bi bi-list tw-absolute tw-right-3 tw-top-3 tw-z-50 tw-text-3xl
             tw-text-black lg:tw-hidden"
      onclick="toggleHeader()"
      aria-label="menu"
      id="collapse-btn"
    ></button>
  </header>

  <div class="map-wrapper tw-flex-1 tw-min-h-0">
    <div id="map"></div>
    <div class="search-box" id="searchBox" style="display: none;">
      <input type="text" id="searchInput" placeholder="Search for a resort..." autocomplete="off" />
      <div class="search-dropdown" id="searchDropdown"></div>
    </div>
    <div id="legend" class="map-legend" style="display: none;"></div>
  </div>

  <footer
    class="tw-flex tw-w-full tw-place-content-around tw-gap-3 tw-border-t tw-border-gray-200
           tw-bg-gray-50 tw-py-6 tw-px-[10%] tw-text-black max-md:tw-flex-col"
  >
    <div
      class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-place-items-center tw-gap-6
             max-md:tw-w-full"
    >
      <img src="./assets/logo.png?v=2" alt="Global Ski Atlas" class="tw-max-w-[120px]" />
      <div>Global Ski Atlas</div>
      <div class="tw-mt-3 tw-text-lg tw-font-semibold">Follow us</div>
      <div class="tw-flex tw-gap-4 tw-text-2xl">
        <a href="" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
        <a href="https://twitter.com/@pauls_freeman" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
        <a href="https://instagram.com/" class="tw-h-[40px] tw-w-[40px]" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
      </div>
    </div>
    <div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-gap-4">
      <h2 class="tw-text-3xl max-md:tw-text-xl">Explore</h2>
      <div class="tw-flex tw-flex-col tw-gap-3 max-md:tw-text-sm">
        <a href="coffee-table-book.html" class="footer-link">Coffee Table Book</a>
        <a href="mainmap.html" class="footer-link">Online Atlas</a>
        <a href="resort-comparison.html" class="footer-link">Compare Resorts</a>
        <a href="index.html#ai-assistant-detail" class="footer-link">AI Assistant</a>
      </div>
    </div>
    <div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-gap-4">
      <h2 class="tw-text-3xl max-md:tw-text-xl">Download Parquet Data</h2>
      <div class="tw-flex tw-flex-col tw-gap-3 max-md:tw-text-sm">
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas_analyzed.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>ski_areas_analyzed.parquet <i class="bi bi-download tw-text-sm"></i></a>
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>ski_areas.parquet <i class="bi bi-download tw-text-sm"></i></a>
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/lifts.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>lifts.parquet <i class="bi bi-download tw-text-sm"></i></a>
        <a href="https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/pistes.parquet" class="footer-link tw-inline-flex tw-items-center tw-gap-1" download>pistes.parquet <i class="bi bi-download tw-text-sm"></i></a>
      </div>
    </div>
    <div class="tw-flex tw-h-full tw-w-[250px] tw-flex-col tw-gap-4">
      <h2 class="tw-text-3xl max-md:tw-text-xl">Resources</h2>
      <div class="tw-flex tw-flex-col tw-gap-3 max-md:tw-text-sm">
        <a href="index.html#about" class="footer-link">About</a>
        <a href="faq.html" class="footer-link">FAQ</a>
        <a href="https://witcoskitech.com" class="footer-link" target="_blank" rel="noopener">Contact</a>
        <a href="privacy-policy.html" class="footer-link">Privacy Policy</a>
      </div>
    </div>
  </footer>

  <script>
    (function () {
      var RESPONSIVE_WIDTH = 1024;
      var isHeaderCollapsed = window.innerWidth < RESPONSIVE_WIDTH;
      var collapseBtn = document.getElementById('collapse-btn');
      var collapseHeaderItems = document.getElementById('collapsed-header-items');
      function onHeaderClickOutside(e) {
        if (collapseHeaderItems && !collapseHeaderItems.contains(e.target) && !collapseBtn.contains(e.target)) {
          toggleHeader();
        }
      }
      function toggleHeader() {
        if (!collapseHeaderItems || !collapseBtn) return;
        if (isHeaderCollapsed) {
          collapseHeaderItems.classList.add('opacity-100');
          collapseHeaderItems.style.width = '60vw';
          collapseBtn.classList.remove('bi-list');
          collapseBtn.classList.add('bi-x', 'max-lg:tw-fixed');
          isHeaderCollapsed = false;
          setTimeout(function () { window.addEventListener('click', onHeaderClickOutside); }, 1);
        } else {
          collapseHeaderItems.classList.remove('opacity-100');
          collapseHeaderItems.style.width = '0vw';
          collapseBtn.classList.remove('bi-x', 'max-lg:tw-fixed');
          collapseBtn.classList.add('bi-list');
          isHeaderCollapsed = true;
          window.removeEventListener('click', onHeaderClickOutside);
        }
      }
      function responsive() {
        if (window.innerWidth >= RESPONSIVE_WIDTH && collapseHeaderItems) {
          collapseHeaderItems.style.width = '';
        } else {
          isHeaderCollapsed = true;
        }
      }
      window.toggleHeader = toggleHeader;
      window.addEventListener('resize', responsive);
    })();
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-textpath@1.2.0/leaflet.textpath.js" crossorigin=""></script>
  <script type="module">
    const MAPTILER_KEY = '0P06ORgY8WvmMOnPr0p2';
    const GEOPARQUET_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas_analyzed.parquet';
    const SKI_AREAS_OUTLINES_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/ski_areas.parquet';
    const LIFTS_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/lifts.parquet';
    const PISTES_URL = 'https://globalskiatlas-backend-k8s-output.s3.us-east-1.amazonaws.com/combined/pistes.parquet';
    const OUTLINES_MIN_ZOOM = 10;
    const LIFTS_MIN_ZOOM = 10;
    const PISTES_MIN_ZOOM = 10;
    // Property keys (tried in order if first missing)
    const RESORT_TYPE_KEYS = ['resort_type', 'Resort Type'];
    const NOT_DOWNHILL = 'not a downhill ski resort';
    const SIZE_BY_KEYS = ['total_area_acres', 'Total Area Acres', 'area_acres'];
    const COLOR_BY_KEYS = ['downhill_trails', 'number_of_downhill_trails', 'Downhill Trails', 'trails'];
    const NAME_KEYS = ['name', 'resort_name', 'title', 'area_name', 'Name'];

    const map = L.map('map', {
      center: [0, 0],
      zoom: 3,
      minZoom: 3,
      maxZoom: 18
    });

    L.tileLayer(
      `https://api.maptiler.com/maps/winter-v4/256/{z}/{x}/{y}.png?key=${MAPTILER_KEY}`,
      {
        attribution: 'Â© <a href="https://www.maptiler.com/copyright/">MapTiler</a> Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        tileSize: 256,
        minZoom: 3,
        maxZoom: 18,
        crossOrigin: true
      }
    ).addTo(map);

    const OLYMPIC_HOSTS = [
      { name: 'Milan', lat: 45.4642, lon: 9.19 },
      { name: 'Cortina d\'Ampezzo', lat: 46.5369, lon: 12.1356 }
    ];
    const olympicRingsSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="36" height="18" style="display:block"><circle cx="12" cy="15" r="6" fill="none" stroke="#0081C8" stroke-width="2"/><circle cx="30" cy="15" r="6" fill="none" stroke="#000" stroke-width="2"/><circle cx="48" cy="15" r="6" fill="none" stroke="#EE334E" stroke-width="2"/><circle cx="21" cy="21" r="6" fill="none" stroke="#FCB131" stroke-width="2"/><circle cx="39" cy="21" r="6" fill="none" stroke="#00A651" stroke-width="2"/></svg>';
    const olympicIcon = L.divIcon({
      className: 'olympic-rings-marker',
      html: '<div title="Milanâ€“Cortina 2026" style="background:#fff;border-radius:50%;padding:2px;box-shadow:0 1px 4px rgba(0,0,0,0.3);line-height:0">' + olympicRingsSvg + '</div>',
      iconSize: [40, 22],
      iconAnchor: [20, 11]
    });
    OLYMPIC_HOSTS.forEach((host) => {
      L.marker([host.lat, host.lon], { icon: olympicIcon })
        .bindTooltip(host.name + ' â€“ Milanâ€“Cortina 2026', { permanent: false, direction: 'top', offset: [0, -10] })
        .addTo(map);
    });

    try {
      const { asyncBufferFromUrl, parquetReadObjects } = await import('https://esm.sh/hyparquet@1');
      const file = await asyncBufferFromUrl({ url: GEOPARQUET_URL });
      const data = await parquetReadObjects({ file });
      const latCol = data.length && (data[0].latitude != null ? 'latitude' : data[0].lat != null ? 'lat' : data[0].centroid_lat != null ? 'centroid_lat' : null);
      const lonCol = data.length && (data[0].longitude != null ? 'longitude' : data[0].lon != null ? 'lon' : data[0].centroid_lon != null ? 'centroid_lon' : null);
      const geojson = {
        type: 'FeatureCollection',
        features: data
          .filter((row) => row.geometry || (latCol && lonCol && row[latCol] != null && row[lonCol] != null))
          .map((row) => {
            if (row.geometry) {
              const { geometry, ...properties } = row;
              return { type: 'Feature', geometry, properties };
            }
            const lat = Number(row[latCol]), lon = Number(row[lonCol]);
            const { [latCol]: _lat, [lonCol]: _lon, ...properties } = row;
            return {
              type: 'Feature',
              geometry: { type: 'Point', coordinates: [lon, lat] },
              properties
            };
          })
      };

      function getProp(props, keyList) {
        if (!props) return undefined;
        for (const k of keyList) {
          if (Object.prototype.hasOwnProperty.call(props, k)) return props[k];
        }
        return undefined;
      }
      function isNotDownhill(props) {
        const v = getProp(props, RESORT_TYPE_KEYS);
        return v != null && String(v).toLowerCase().trim() === NOT_DOWNHILL.toLowerCase();
      }

      const TRAILS_RED = 10;   // < 10 trails = red
      const TRAILS_YELLOW = 30; // 10â€“30 = yellow, 30+ = green
      const sizeExtent = [Infinity, -Infinity];
      geojson.features.forEach((f) => {
        if (isNotDownhill(f.properties)) return;
        const sv = getProp(f.properties, SIZE_BY_KEYS);
        if (typeof sv === 'number' && !Number.isNaN(sv) && sv > 0) {
          sizeExtent[0] = Math.min(sizeExtent[0], sv);
          sizeExtent[1] = Math.max(sizeExtent[1], sv);
        }
      });
      if (sizeExtent[0] === Infinity) sizeExtent[0] = 0;
      if (sizeExtent[1] === -Infinity) sizeExtent[1] = 1;

      const TRAILS_MEDIUM = 30; // < 10 = small hill, 10â€“30 = ski mountain, 30+ = multiple mountains
      function getTrailCount(feature) {
        const v = getProp(feature.properties, COLOR_BY_KEYS);
        if (v == null || v === '') return 0;
        const n = typeof v === 'number' ? v : Number(v);
        return Number.isNaN(n) ? 0 : n;
      }
      function getSizeTier(feature) {
        if (isNotDownhill(feature.properties)) return 'small';
        const n = getTrailCount(feature);
        if (n < TRAILS_RED) return 'small';   // < 10 trails â†’ small hill
        if (n < TRAILS_MEDIUM) return 'medium'; // 10â€“30 â†’ ski mountain
        return 'large';                         // 30+ â†’ multiple mountains
      }
      function getColorFor(feature) {
        if (isNotDownhill(feature.properties)) return '#999999';
        const v = getProp(feature.properties, COLOR_BY_KEYS);
        if (v == null || v === '' || (typeof v === 'number' && Number.isNaN(v))) return '#c44d34';
        const n = typeof v === 'number' ? v : Number(v);
        if (Number.isNaN(n)) return '#c44d34';
        if (n < TRAILS_RED) return '#c44d34';   // red: < 10 trails
        if (n < TRAILS_MEDIUM) return '#e6c229'; // yellow: 10â€“30
        return '#2d8a3e';                        // green: 30+
      }

      const hillSvg = (color, w, h) => '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 16" width="' + w + '" height="' + h + '" style="display:block"><path d="M0 16 L0 11 Q6 6 12 11 Q18 6 24 11 L24 16 Z" fill="' + color + '" stroke="#1a1a1a" stroke-width="0.8"/></svg>';
      const mountainSvg = (color, w, h) => '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 16" width="' + w + '" height="' + h + '" style="display:block"><path d="M0 16 L8 5 L16 10 L24 16 Z" fill="' + color + '" stroke="#1a1a1a" stroke-width="0.8"/></svg>';
      const mountainsSvg = (color, w, h) => '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 16" width="' + w + '" height="' + h + '" style="display:block"><path d="M0 16 L4 10 L8 14 L10 9 L14 5 L18 10 L20 7 L24 16 Z" fill="' + color + '" stroke="#1a1a1a" stroke-width="0.8"/></svg>';
      function getMountainIcon(feature) {
        const tier = getSizeTier(feature);
        const color = getColorFor(feature);
        let w = 20, h = 14;
        if (tier === 'medium') { w = 26; h = 18; }
        else if (tier === 'large') { w = 32; h = 20; }
        let svg;
        if (tier === 'small') svg = hillSvg(color, w, h);
        else if (tier === 'medium') svg = mountainSvg(color, w, h);
        else svg = mountainsSvg(color, w, h);
        return L.divIcon({
          className: 'mountain-marker',
          html: '<div style="line-height:0;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))">' + svg + '</div>',
          iconSize: [w, h],
          iconAnchor: [w / 2, h]
        });
      }

      const legendEl = document.getElementById('legend');
      legendEl.style.display = 'block';
      legendEl.innerHTML =
        '<h3>Resort size (by trails)</h3>' +
        '<div class="legend-row"><span class="legend-mountain-icon">' + hillSvg('#c44d34', 20, 14) + '</span> Small hill (&lt; 10 trails)</div>' +
        '<div class="legend-row"><span class="legend-mountain-icon">' + mountainSvg('#e6c229', 22, 15) + '</span> Ski mountain (10â€“30)</div>' +
        '<div class="legend-row"><span class="legend-mountain-icon">' + mountainsSvg('#2d8a3e', 24, 16) + '</span> Multiple mountains (30+)</div>' +
        '<div class="legend-row" style="margin-top:6px"><span class="legend-mountain-icon">' + hillSvg('#999', 18, 12) + '</span> Grey = not a downhill ski resort</div>' +
        '<h3 style="margin-top:10px">Pistes (zoom 10+) â€“ US colors</h3>' +
        '<div class="legend-row"><span class="legend-line" style="background:#22c55e"></span> Green = easy</div>' +
        '<div class="legend-row"><span class="legend-line" style="background:#2563eb"></span> Blue = intermediate</div>' +
        '<div class="legend-row"><span class="legend-line" style="background:#1a1a1a"></span> Black = advanced</div>' +
        '<div class="legend-row"><span class="legend-line" style="background:#991b1b"></span> Red = expert</div>';

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatPopupValue(v) {
        if (v == null) return 'â€”';
        if (typeof v === 'number') return Number.isInteger(v) ? v.toLocaleString() : Number(v).toLocaleString(undefined, { maximumFractionDigits: 2 });
        if (typeof v === 'boolean') return v ? 'Yes' : 'No';
        if (v && typeof v === 'object' && typeof v.toISOString === 'function') return v.toISOString().slice(0, 10);
        return String(v);
      }
      function labelForKey(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
      }
      const ID_KEYS = ['id', 'ref', 'area_id', 'resort_id', 'skiresort_id'];
      function buildPopupHtml(properties, latlng) {
        if (!properties || !Object.keys(properties).length) return '<em>No data</em>';
        const name = getProp(properties, NAME_KEYS);
        const displayName = name ? escapeHtml(String(name)) : 'Resort';
        const id = getProp(properties, ID_KEYS);
        const lat = latlng && latlng.lat != null ? latlng.lat : null;
        const lon = latlng && latlng.lng != null ? latlng.lng : null;
        const params = new URLSearchParams();
        if (id != null && id !== '') params.set('id', String(id));
        if (name != null && name !== '') params.set('name', String(name));
        if (lat != null && !Number.isNaN(lat)) params.set('lat', String(lat));
        if (lon != null && !Number.isNaN(lon)) params.set('lon', String(lon));
        const qs = params.toString();
        const popupUrl = new URL('popup.html', location.href).href + (qs ? '?' + qs : '');
        const stored = JSON.stringify({ name: name || null, id: id != null ? String(id) : null, lat, lon });
        const storedAttr = stored.replace(/"/g, '&quot;');
        return '<p style="margin:0 0 8px 0;font-weight:600">' + displayName + '</p>' +
          '<a href="#" data-resort-url="' + escapeHtml(popupUrl) + '" data-resort-stored="' + storedAttr + '" class="resort-details-link tw-inline-flex tw-items-center tw-gap-1 tw-rounded-lg tw-bg-[#2563eb] tw-px-3 tw-py-2 tw-text-sm tw-font-medium tw-text-white tw-no-underline hover:tw-bg-[#1d4ed8]" style="display:inline-flex;align-items:center;gap:4px;border-radius:8px;background:#2563eb;color:#fff;padding:8px 12px;text-decoration:none;cursor:pointer;">View details <i class="bi bi-arrow-up-right"></i></a>';
      }

      const searchResorts = [];
      const resortsLayer = L.geoJSON(geojson, {
        pointToLayer: function (feature, latlng) {
          const icon = getMountainIcon(feature);
          return L.marker(latlng, { icon });
        },
        onEachFeature: function (feature, layer) {
          const latlng = layer.getLatLng ? layer.getLatLng() : null;
          layer.bindPopup(buildPopupHtml(feature.properties, latlng), { maxWidth: 320 });
          const name = getProp(feature.properties, NAME_KEYS);
          if (name != null && String(name).trim() !== '') {
            searchResorts.push({
              name: String(name).trim(),
              layer,
              latlng: layer.getLatLng()
            });
          }
        }
      });
      resortsLayer.addTo(map);

      map.on('popupopen', (ev) => {
        const link = ev.popup.getElement && ev.popup.getElement().querySelector('.resort-details-link');
        if (link) {
          console.log('[mainmap popupopen] link in DOM:', {
            dataResortUrl: link.getAttribute('data-resort-url'),
            dataResortStored: link.getAttribute('data-resort-stored')
          });
        } else {
          console.log('[mainmap popupopen] no .resort-details-link found in popup');
        }
      });

      const searchBox = document.getElementById('searchBox');
      const searchInput = document.getElementById('searchInput');
      const searchDropdown = document.getElementById('searchDropdown');
      if (searchResorts.length) searchBox.style.display = 'block';

      const maxSuggestions = 8;
      let selectedIndex = -1;
      let currentMatches = [];

      function renderDropdown(matches) {
        currentMatches = matches.slice(0, maxSuggestions);
        selectedIndex = -1;
        if (currentMatches.length === 0) {
          searchDropdown.classList.remove('visible');
          searchDropdown.innerHTML = '';
          return;
        }
        searchDropdown.innerHTML = currentMatches.map((r, i) =>
          '<div class="search-item" data-index="' + i + '">' + escapeHtml(r.name) + '</div>'
        ).join('');
        searchDropdown.classList.add('visible');
        searchDropdown.querySelectorAll('.search-item').forEach((el, i) => {
          el.addEventListener('click', () => selectMatch(currentMatches[i]));
        });
      }
      function selectMatch(r) {
        searchDropdown.classList.remove('visible');
        searchInput.value = r.name;
        searchInput.blur();
        map.flyTo(r.latlng, 10, { duration: 0.6 });
        setTimeout(() => r.layer.openPopup(), 400);
      }
      function getMatches(query) {
        const q = query.toLowerCase().trim();
        if (q.length === 0) return [];
        return searchResorts.filter((r) => r.name.toLowerCase().includes(q));
      }

      searchInput.addEventListener('input', () => {
        renderDropdown(getMatches(searchInput.value));
      });
      searchInput.addEventListener('focus', () => {
        const q = searchInput.value.trim();
        renderDropdown(q.length ? getMatches(q) : []);
      });
      searchInput.addEventListener('keydown', (e) => {
        if (!searchDropdown.classList.contains('visible') || currentMatches.length === 0) return;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedIndex = Math.min(selectedIndex + 1, currentMatches.length - 1);
          searchDropdown.querySelectorAll('.search-item').forEach((el, i) => el.classList.toggle('active', i === selectedIndex));
          return;
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedIndex = Math.max(selectedIndex - 1, -1);
          searchDropdown.querySelectorAll('.search-item').forEach((el, i) => el.classList.toggle('active', i === selectedIndex));
          return;
        }
        if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && currentMatches[selectedIndex]) selectMatch(currentMatches[selectedIndex]);
          else if (currentMatches[0]) selectMatch(currentMatches[0]);
          return;
        }
      });
      document.addEventListener('click', (e) => {
        if (!searchBox.contains(e.target)) searchDropdown.classList.remove('visible');
      });

      document.addEventListener('click', (e) => {
        const link = e.target.closest('.resort-details-link');
        if (link) {
          e.preventDefault();
          const url = link.getAttribute('data-resort-url');
          const stored = link.getAttribute('data-resort-stored');
          console.log('[mainmap click] View details clicked', { url: url ? url.slice(-80) : null, stored, hasStoredAttr: !!stored });
          if (stored) {
            try {
              localStorage.setItem('resortDetails', stored);
              console.log('[mainmap click] localStorage.setItem done, verify:', localStorage.getItem('resortDetails'));
            } catch (err) { console.error('[mainmap click] localStorage error', err); }
          }
          if (url) window.open(url, '_blank', 'noopener');
          console.log('[mainmap click] window.open called');
        }
      });

      // Ski area polygon outlines (visible at zoom 10+)
      // Viewport filtering: only render features intersecting map bounds to avoid overload in dense regions (e.g. Japan)
      function getFeatureBounds(feature) {
        const g = feature.geometry;
        if (!g || !g.coordinates) return null;
        let minLat = 90, maxLat = -90, minLon = 180, maxLon = -180;
        function process(c) {
          if (typeof c[0] === 'number') {
            minLon = Math.min(minLon, c[0]); maxLon = Math.max(maxLon, c[0]);
            minLat = Math.min(minLat, c[1]); maxLat = Math.max(maxLat, c[1]);
          } else c.forEach(process);
        }
        if (g.type === 'Point') process(g.coordinates);
        else if (g.type === 'LineString') g.coordinates.forEach(process);
        else if (g.type === 'Polygon') g.coordinates.forEach(r => r.forEach(process));
        else if (g.type === 'MultiLineString') g.coordinates.forEach(r => r.forEach(process));
        else if (g.type === 'MultiPolygon') g.coordinates.forEach(m => m.forEach(r => r.forEach(process)));
        return L.latLngBounds([minLat, minLon], [maxLat, maxLon]);
      }
      function featuresInViewport(features, bounds) {
        if (!bounds || !features || !features.length) return [];
        const pad = bounds.pad ? bounds.pad(0.15) : bounds;
        return features.filter((f) => {
          const fb = getFeatureBounds(f);
          return fb && pad.intersects(fb);
        });
      }

      let outlinesLayer = null;
      let outlinesGeojson = null;
      try {
        const fileOutlines = await asyncBufferFromUrl({ url: SKI_AREAS_OUTLINES_URL });
        const dataOutlines = await parquetReadObjects({ file: fileOutlines });
        outlinesGeojson = {
          type: 'FeatureCollection',
          features: dataOutlines
            .filter((row) => {
              const g = row.geometry;
              if (!g || !g.type) return false;
              const t = g.type;
              return t === 'Polygon' || t === 'MultiPolygon';
            })
            .map((row) => {
              const { geometry, ...properties } = row;
              return { type: 'Feature', geometry, properties };
            })
        };
        outlinesLayer = L.layerGroup();
      } catch (outlineErr) {
        console.warn('Ski area outlines failed to load:', outlineErr);
      }

      let liftsLayer = null;
      let liftsGeojson = null;
      let liftIcon = null;
      function getLineMidpoint(latlngs) {
        const flat = Array.isArray(latlngs[0]) && (typeof latlngs[0][0] === 'number' || (latlngs[0][0] && latlngs[0][0].lat == null))
          ? latlngs[0]
          : latlngs;
        if (!flat || !flat.length) return null;
        const i = Math.floor(flat.length / 2);
        return L.latLng(flat[i]);
      }
      try {
        const fileLifts = await asyncBufferFromUrl({ url: LIFTS_URL });
        const dataLifts = await parquetReadObjects({ file: fileLifts });
        liftsGeojson = {
          type: 'FeatureCollection',
          features: dataLifts
            .filter((row) => {
              const g = row.geometry;
              if (!g || !g.type) return false;
              const t = g.type;
              return t === 'LineString' || t === 'MultiLineString';
            })
            .map((row) => {
              const { geometry, ...properties } = row;
              return { type: 'Feature', geometry, properties };
            })
        };
        liftIcon = L.divIcon({
          className: 'lift-marker-icon',
          html: '<span style="font-size:14px;line-height:1;color:#dc2626;filter:drop-shadow(0 0 1px #fff);" title="Lift">ðŸš¡</span>',
          iconSize: [18, 18],
          iconAnchor: [9, 9]
        });
        liftsLayer = L.layerGroup();
      } catch (liftErr) {
        console.warn('Lifts GeoParquet failed to load:', liftErr);
      }

      let pistesLayer = null;
      let pistesGeojson = null;
      const PISTE_DIFFICULTY_KEYS = ['piste:difficulty', 'piste_difficulty', 'difficulty'];
      function getPisteDifficulty(props) {
        let v = getProp(props, PISTE_DIFFICULTY_KEYS);
        if (v == null && props && typeof props.other_tags === 'string') {
          const m = props.other_tags.match(/"piste:difficulty"=>"([^"]+)"/);
          if (m) v = m[1];
        }
        return v != null ? String(v).toLowerCase().trim() : '';
      }
      function getPisteStyle(feature) {
        const d = getPisteDifficulty(feature.properties);
        if (d === 'easy' || d === 'novice') return { color: '#22c55e', weight: 3, opacity: 0.95 };
        if (d === 'intermediate' || d === 'medium') return { color: '#2563eb', weight: 3, opacity: 0.95 };
        if (d === 'advanced' || d === 'hard') return { color: '#1a1a1a', weight: 3.5, opacity: 0.95 };
        if (d === 'expert' || d === 'freeride' || d === 'extreme') return { color: '#991b1b', weight: 4, opacity: 0.95 };
        return { color: '#64748b', weight: 2, opacity: 0.8 };
      }
      try {
        const filePistes = await asyncBufferFromUrl({ url: PISTES_URL });
        const dataPistes = await parquetReadObjects({ file: filePistes });
        pistesGeojson = {
          type: 'FeatureCollection',
          features: dataPistes
            .filter((row) => {
              const g = row.geometry;
              if (!g || !g.type) return false;
              const t = g.type;
              return t === 'LineString' || t === 'MultiLineString';
            })
            .map((row) => {
              const { geometry, ...properties } = row;
              return { type: 'Feature', geometry, properties };
            })
        };
        pistesLayer = L.layerGroup();
      } catch (pisteErr) {
        console.warn('Pistes GeoParquet failed to load:', pisteErr);
      }

      const outlineStyle = { color: '#000', weight: 2, fill: false, dashArray: '3, 6' };
      const liftLineStyle = { color: '#f87171', weight: 2, opacity: 0.9 };

      function populateVisibleLayers() {
        const zoom = map.getZoom();
        const showHeavy = zoom >= OUTLINES_MIN_ZOOM;
        const bounds = showHeavy ? map.getBounds() : null;

        if (outlinesLayer) {
          outlinesLayer.clearLayers();
          if (showHeavy && outlinesGeojson && bounds) {
            const visible = featuresInViewport(outlinesGeojson.features, bounds);
            visible.forEach((feature) => {
              const polygonLayer = L.geoJSON(feature, { style: outlineStyle });
              polygonLayer.eachLayer((l) => outlinesLayer.addLayer(l));
              const name = getProp(feature.properties, NAME_KEYS);
              if (name == null || String(name).trim() === '') return;
              const geom = feature.geometry;
              let ring;
              if (geom.type === 'Polygon' && geom.coordinates && geom.coordinates[0]) {
                ring = geom.coordinates[0];
              } else if (geom.type === 'MultiPolygon' && geom.coordinates && geom.coordinates[0] && geom.coordinates[0][0]) {
                ring = geom.coordinates[0][0];
              } else return;
              const latlngs = ring.map((c) => L.latLng(c[1], c[0]));
              const pathLine = L.polyline(latlngs, { color: 'transparent', weight: 0, opacity: 0 });
              if (typeof pathLine.setText === 'function') {
                pathLine.setText(String(name).trim(), {
                  repeat: false,
                  center: true,
                  attributes: { fill: '#1a1a1a', 'font-weight': 'bold', 'font-size': '13px' }
                });
              }
              outlinesLayer.addLayer(pathLine);
            });
          }
        }

        if (liftsLayer && liftIcon) {
          liftsLayer.clearLayers();
          if (showHeavy && liftsGeojson && bounds) {
            const visible = featuresInViewport(liftsGeojson.features, bounds);
            visible.forEach((feature) => {
              const lineLayer = L.geoJSON(feature, { style: liftLineStyle });
              lineLayer.eachLayer((ll) => {
                liftsLayer.addLayer(ll);
                const latlngs = ll.getLatLngs();
                const mid = latlngs.length ? getLineMidpoint(latlngs) : null;
                if (mid) liftsLayer.addLayer(L.marker(mid, { icon: liftIcon }));
              });
            });
          }
        }

        if (pistesLayer) {
          pistesLayer.clearLayers();
          if (showHeavy && pistesGeojson && bounds) {
            const visible = featuresInViewport(pistesGeojson.features, bounds);
            const filtered = { type: 'FeatureCollection', features: visible };
            const temp = L.geoJSON(filtered, { style: getPisteStyle });
            temp.eachLayer((l) => pistesLayer.addLayer(l));
          }
        }
      }

      function updateZoomLayersVisibility() {
        const zoom = map.getZoom();
        populateVisibleLayers();
        if (outlinesLayer) {
          if (zoom >= OUTLINES_MIN_ZOOM) {
            if (!map.hasLayer(outlinesLayer)) map.addLayer(outlinesLayer);
          } else {
            if (map.hasLayer(outlinesLayer)) map.removeLayer(outlinesLayer);
          }
        }
        if (liftsLayer) {
          if (zoom >= LIFTS_MIN_ZOOM) {
            if (!map.hasLayer(liftsLayer)) map.addLayer(liftsLayer);
          } else {
            if (map.hasLayer(liftsLayer)) map.removeLayer(liftsLayer);
          }
        }
        if (pistesLayer) {
          if (zoom >= PISTES_MIN_ZOOM) {
            if (!map.hasLayer(pistesLayer)) map.addLayer(pistesLayer);
          } else {
            if (map.hasLayer(pistesLayer)) map.removeLayer(pistesLayer);
          }
        }
      }

      let viewportUpdateTimer = null;
      function scheduleViewportUpdate() {
        if (viewportUpdateTimer) clearTimeout(viewportUpdateTimer);
        viewportUpdateTimer = setTimeout(() => {
          viewportUpdateTimer = null;
          if (map.getZoom() >= OUTLINES_MIN_ZOOM) populateVisibleLayers();
        }, 150);
      }

      map.on('zoomend', updateZoomLayersVisibility);
      map.on('moveend', scheduleViewportUpdate);
      updateZoomLayersVisibility();
    } catch (err) {
      console.warn('Ski areas GeoParquet failed to load:', err);
      if (err.message && err.message.includes('fetch')) {
        console.warn('Tip: Add CORS and allow public GetObject on the S3 bucket. See docs/S3_EXPOSE_GEOPARQUET.md');
      }
    }
  </script>
</body>
</html>
